name: android-apk

on:
  workflow_dispatch:
    inputs:
      source_ref:
        description: "Git ref (branch/tag/SHA) in the private source repo"
        required: true
        default: "main"
      artifact_name:
        description: "Artifact name"
        required: true
        default: "app-debug"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout private source repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.SOURCE_REPO_FULL_NAME }}
          ref: ${{ inputs.source_ref }}
          ssh-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
          fetch-depth: 1
          path: source

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android packages
        run: |
          yes | sdkmanager --licenses
          sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "ndk;26.1.10909125" \
            "cmake;3.22.1"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: "8.6"
          cache-disabled: true

      - name: Build Debug APK (via source repo script)
        working-directory: source
        env:
          CI_OUT_DIR: ${{ github.workspace }}/out/ci
        run: |
          bash tool/ci/build_android_apk.sh

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: out/ci/
          retention-days: 1
